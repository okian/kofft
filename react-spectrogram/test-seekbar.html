<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seekbar Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
        }
        .seekbar-demo {
            margin: 20px 0;
            padding: 20px;
            background: #333;
            border-radius: 4px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #357abd;
        }
        input[type="range"] {
            width: 200px;
        }
        .info {
            margin: 10px 0;
            font-size: 14px;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Waveform Seekbar Test</h1>
        
        <div class="seekbar-demo">
            <h3>Test Seekbar</h3>
            <div id="seekbar-container" style="height: 60px; background: #444; border-radius: 4px; position: relative;"></div>
            
            <div class="controls">
                <button onclick="playPause()">Play/Pause</button>
                <button onclick="reset()">Reset</button>
                <input type="range" id="time-slider" min="0" max="100" value="0" oninput="updateTime(this.value)">
                <span id="time-display">00:00 / 00:00</span>
            </div>
            
            <div class="info">
                <p>Current Time: <span id="current-time">0</span>s</p>
                <p>Duration: <span id="duration">0</span>s</p>
                <p>Seek Position: <span id="seek-position">0</span>%</p>
            </div>
        </div>
    </div>

    <script>
        // Mock audio data for testing
        const sampleRate = 44100;
        const duration = 180; // 3 minutes
        const audioData = new Float32Array(sampleRate * duration);
        
        // Generate some test audio data (sine wave with varying amplitude)
        for (let i = 0; i < audioData.length; i++) {
            const time = i / sampleRate;
            const frequency = 440 + Math.sin(time * 0.1) * 100; // Varying frequency
            const amplitude = 0.3 + Math.sin(time * 0.5) * 0.2; // Varying amplitude
            audioData[i] = Math.sin(2 * Math.PI * frequency * time) * amplitude;
        }

        let currentTime = 0;
        let isPlaying = false;
        let animationId = null;

        // Mock seekbar component
        class MockSeekbar {
            constructor(container, audioData, onSeek) {
                this.container = container;
                this.audioData = audioData;
                this.onSeek = onSeek;
                this.currentTime = 0;
                this.duration = duration;
                this.numBars = 300;
                this.barWidth = 2;
                this.barGap = 1;
                this.maxBarHeight = 30;
                
                this.render();
                this.setupEventListeners();
            }

            render() {
                this.container.innerHTML = `
                    <canvas id="seekbar-canvas" width="${this.container.offsetWidth}" height="${this.container.offsetHeight}"></canvas>
                    <div style="position: absolute; top: 0; left: 0; right: 0; display: flex; justify-content: space-between; padding: 0 10px; font-size: 12px; color: #ccc;">
                        <span>${this.formatTime(this.currentTime)}</span>
                        <span>${this.formatTime(this.duration)}</span>
                    </div>
                `;
                
                this.canvas = this.container.querySelector('#seekbar-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.drawBars();
            }

            generateEnvelope() {
                const envelope = new Float32Array(this.numBars);
                const samplesPerBar = Math.ceil(this.audioData.length / this.numBars);
                
                for (let i = 0; i < this.numBars; i++) {
                    const start = i * samplesPerBar;
                    const end = Math.min(start + samplesPerBar, this.audioData.length);
                    const chunk = this.audioData.slice(start, end);
                    
                    if (chunk.length > 0) {
                        const sumSquares = chunk.reduce((sum, sample) => sum + sample * sample, 0);
                        const rms = Math.sqrt(sumSquares / chunk.length);
                        envelope[i] = rms;
                    }
                }
                
                // Normalize
                const maxVal = Math.max(...envelope);
                if (maxVal > 0) {
                    for (let i = 0; i < envelope.length; i++) {
                        envelope[i] = envelope[i] / maxVal;
                    }
                }
                
                return envelope;
            }

            drawBars() {
                const envelope = this.generateEnvelope();
                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;
                
                ctx.clearRect(0, 0, width, height);
                
                const totalWidth = this.numBars * (this.barWidth + this.barGap) - this.barGap;
                const startX = (width - totalWidth) / 2;
                const centerY = height / 2;
                const currentPosition = this.currentTime / this.duration;
                
                // Draw bars
                for (let i = 0; i < this.numBars; i++) {
                    const barPosition = i / (this.numBars - 1);
                    const isPlayed = barPosition <= currentPosition;
                    const amplitude = envelope[i] || 0;
                    
                    const barHeight = Math.max(amplitude * this.maxBarHeight, 2);
                    const y = centerY - barHeight / 2;
                    const x = startX + i * (this.barWidth + this.barGap);
                    
                    ctx.fillStyle = isPlayed ? '#3b82f6' : '#4b5563';
                    ctx.beginPath();
                    ctx.roundRect(x, y, this.barWidth, barHeight, this.barWidth / 2);
                    ctx.fill();
                }
                
                // Draw playhead
                const playheadX = startX + currentPosition * totalWidth;
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(playheadX, 0);
                ctx.lineTo(playheadX, height);
                ctx.stroke();
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            setupEventListeners() {
                this.canvas.addEventListener('click', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const position = Math.max(0, Math.min(1, x / rect.width));
                    const newTime = position * this.duration;
                    this.onSeek(newTime);
                });
            }

            updateTime(time) {
                this.currentTime = time;
                this.drawBars();
                this.render();
            }
        }

        // Initialize seekbar
        const seekbarContainer = document.getElementById('seekbar-container');
        const seekbar = new MockSeekbar(seekbarContainer, audioData, (time) => {
            currentTime = time;
            updateDisplay();
            document.getElementById('time-slider').value = (time / duration) * 100;
        });

        function updateDisplay() {
            document.getElementById('current-time').textContent = currentTime.toFixed(1);
            document.getElementById('duration').textContent = duration.toFixed(1);
            document.getElementById('seek-position').textContent = ((currentTime / duration) * 100).toFixed(1);
            document.getElementById('time-display').textContent = 
                `${seekbar.formatTime(currentTime)} / ${seekbar.formatTime(duration)}`;
        }

        function updateTime(value) {
            const time = (value / 100) * duration;
            currentTime = time;
            seekbar.updateTime(time);
            updateDisplay();
        }

        function playPause() {
            isPlaying = !isPlaying;
            if (isPlaying) {
                animate();
            } else {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
            }
        }

        function reset() {
            currentTime = 0;
            seekbar.updateTime(0);
            updateDisplay();
            document.getElementById('time-slider').value = 0;
        }

        function animate() {
            if (!isPlaying) return;
            
            currentTime += 0.1;
            if (currentTime >= duration) {
                currentTime = 0;
            }
            
            seekbar.updateTime(currentTime);
            updateDisplay();
            document.getElementById('time-slider').value = (currentTime / duration) * 100;
            
            animationId = requestAnimationFrame(animate);
        }

        // Initialize display
        updateDisplay();
    </script>
</body>
</html>
