<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB Metadata Store Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #60a5fa;
        }
        .stat-label {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗄️ IndexedDB Metadata Store Test</h1>
        <p>This page tests the IndexedDB-based metadata storage system.</p>
        
        <div>
            <button onclick="testDatabaseInit()">🔧 Test Database Initialization</button>
            <button onclick="testMetadataStorage()">💾 Test Metadata Storage</button>
            <button onclick="testMetadataRetrieval()">📦 Test Metadata Retrieval</button>
            <button onclick="getDatabaseStats()">📊 Get Database Statistics</button>
            <button onclick="cleanupUnusedArt()">🧹 Cleanup Unused Album Art</button>
            <button onclick="clearAllData()">🗑️ Clear All Data</button>
        </div>
        
        <div id="status" class="info"></div>
        <div id="results"></div>
    </div>

    <script type="module">
        // Import the metadata store
        let metadataStore = null;

        // Mock metadata store for testing
        class MockMetadataStore {
            constructor() {
                this.db = null;
                this.initPromise = null;
            }

            async init() {
                if (this.db) return this.db;
                if (this.initPromise) return this.initPromise;

                this.initPromise = new Promise((resolve, reject) => {
                    const request = indexedDB.open('TestMetadataDB', 1);

                    request.onerror = () => {
                        console.error('Failed to open IndexedDB:', request.error);
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('✅ Test IndexedDB initialized successfully');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        console.log('🔧 Creating test IndexedDB schema...');

                        // Create stores
                        const metadataStore = db.createObjectStore('metadata', { keyPath: 'id', autoIncrement: true });
                        metadataStore.createIndex('hash', 'hash', { unique: true });

                        const albumArtStore = db.createObjectStore('album_art', { keyPath: 'id', autoIncrement: true });
                        albumArtStore.createIndex('hash', 'hash', { unique: true });

                        console.log('✅ Test IndexedDB schema created successfully');
                    };
                });

                return this.initPromise;
            }

            async storeMetadata(file, metadata, arrayBuffer) {
                const db = await this.init();
                const hash = await this.computeHash(arrayBuffer);
                const now = new Date();

                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['metadata', 'album_art'], 'readwrite');
                    
                    let albumArtId = undefined;

                    // Store album art if available
                    if (metadata.album_art && metadata.album_art.length > 0) {
                        const albumArtStore = transaction.objectStore('album_art');
                        const albumArtHash = this.computeAlbumArtHash(metadata.album_art);
                        
                        const albumArtRecord = {
                            hash: albumArtHash,
                            data: metadata.album_art,
                            mime_type: metadata.album_art_mime || 'image/jpeg',
                            size: metadata.album_art.length,
                            created_at: now,
                            last_used: now,
                            use_count: 1
                        };

                        const addRequest = albumArtStore.add(albumArtRecord);
                        addRequest.onsuccess = () => {
                            albumArtId = addRequest.result;
                        };
                    }

                    // Store metadata
                    const metadataStore = transaction.objectStore('metadata');
                    const metadataRecord = {
                        hash,
                        title: metadata.title || file.name.replace(/\.[^/.]+$/, ''),
                        artist: metadata.artist || 'Unknown Artist',
                        album: metadata.album || 'Unknown Album',
                        year: metadata.year,
                        genre: metadata.genre,
                        duration: metadata.duration || 0,
                        sample_rate: metadata.sample_rate || 0,
                        channels: metadata.channels || 0,
                        bit_depth: metadata.bit_depth || 0,
                        bitrate: metadata.bitrate || 0,
                        format: metadata.format || 'unknown',
                        album_art_hash: albumArtId,
                        album_art_mime: metadata.album_art_mime,
                        file_size: file.size,
                        created_at: now,
                        updated_at: now
                    };

                    const metadataRequest = metadataStore.add(metadataRecord);
                    let metadataId;

                    metadataRequest.onsuccess = () => {
                        metadataId = metadataRequest.result;
                        
                        transaction.oncomplete = () => {
                            console.log('✅ Test metadata stored successfully:', { metadataId, albumArtId });
                            resolve({ metadataId, albumArtId });
                        };

                        transaction.onerror = () => {
                            console.error('❌ Failed to store test metadata:', transaction.error);
                            reject(transaction.error);
                        };
                    };
                });
            }

            async getMetadata(hash) {
                const db = await this.init();
                
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['metadata'], 'readonly');
                    const store = transaction.objectStore('metadata');
                    const request = store.index('hash').get(hash);
                    
                    request.onsuccess = () => {
                        resolve(request.result || null);
                    };
                    
                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            }

            async getStats() {
                const db = await this.init();
                
                const getCount = (storeName) => {
                    return new Promise((resolve, reject) => {
                        const transaction = db.transaction([storeName], 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.count();
                        
                        request.onsuccess = () => {
                            resolve(request.result);
                        };
                        
                        request.onerror = () => {
                            reject(request.error);
                        };
                    });
                };
                
                const [metadataCount, albumArtCount] = await Promise.all([
                    getCount('metadata'),
                    getCount('album_art')
                ]);
                
                return {
                    metadataCount,
                    albumArtCount,
                    albumCount: 0, // Simplified for test
                    artistCount: 0,
                    genreCount: 0,
                    yearCount: 0,
                    trackCount: metadataCount
                };
            }

            async clearAll() {
                const db = await this.init();
                
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['metadata', 'album_art'], 'readwrite');
                    
                    transaction.objectStore('metadata').clear();
                    transaction.objectStore('album_art').clear();
                    
                    transaction.oncomplete = () => {
                        console.log('🗑️ All test data cleared');
                        resolve();
                    };
                    
                    transaction.onerror = () => {
                        reject(transaction.error);
                    };
                });
            }

            async computeHash(data) {
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                return Array.from(new Uint8Array(hashBuffer))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            }

            computeAlbumArtHash(artworkData) {
                // Simplified hash for testing
                return this.computeHash(artworkData.buffer);
            }
        }

        // Initialize mock store
        metadataStore = new MockMetadataStore();

        // Test functions
        window.testDatabaseInit = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                statusDiv.innerHTML = '<span class="info">🔧 Testing database initialization...</span>';
                
                await metadataStore.init();
                
                statusDiv.innerHTML = '<span class="success">✅ Database initialized successfully!</span>';
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>✅ Database Initialization Test</h3>
                        <p>IndexedDB database created and initialized successfully.</p>
                        <p>Database name: TestMetadataDB</p>
                        <p>Version: 1</p>
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">❌ Database initialization failed: ${error.message}</span>`;
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Database Initialization Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        };

        window.testMetadataStorage = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                statusDiv.innerHTML = '<span class="info">💾 Testing metadata storage...</span>';
                
                // Create mock file and metadata
                const mockFile = new File(['mock audio data'], 'test-song.mp3', { type: 'audio/mpeg' });
                const mockMetadata = {
                    title: 'Test Song',
                    artist: 'Test Artist',
                    album: 'Test Album',
                    year: 2024,
                    genre: 'Test Genre',
                    duration: 180.5,
                    sample_rate: 44100,
                    channels: 2,
                    bit_depth: 16,
                    bitrate: 320,
                    format: 'mp3',
                    album_art: new Uint8Array([0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46]), // Mock JPEG header
                    album_art_mime: 'image/jpeg'
                };
                const mockArrayBuffer = new ArrayBuffer(1024);
                
                const result = await metadataStore.storeMetadata(mockFile, mockMetadata, mockArrayBuffer);
                
                statusDiv.innerHTML = '<span class="success">✅ Metadata stored successfully!</span>';
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>✅ Metadata Storage Test</h3>
                        <p><strong>Metadata ID:</strong> ${result.metadataId}</p>
                        <p><strong>Album Art ID:</strong> ${result.albumArtId || 'None'}</p>
                        <p><strong>Title:</strong> ${mockMetadata.title}</p>
                        <p><strong>Artist:</strong> ${mockMetadata.artist}</p>
                        <p><strong>Album:</strong> ${mockMetadata.album}</p>
                        <p><strong>Duration:</strong> ${mockMetadata.duration}s</p>
                        <p><strong>Album Art:</strong> ${mockMetadata.album_art ? 'Yes' : 'No'}</p>
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">❌ Metadata storage failed: ${error.message}</span>`;
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Metadata Storage Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        };

        window.testMetadataRetrieval = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                statusDiv.innerHTML = '<span class="info">📦 Testing metadata retrieval...</span>';
                
                // Create mock array buffer to get hash
                const mockArrayBuffer = new ArrayBuffer(1024);
                const hash = await metadataStore.computeHash(mockArrayBuffer);
                
                const metadata = await metadataStore.getMetadata(hash);
                
                if (metadata) {
                    statusDiv.innerHTML = '<span class="success">✅ Metadata retrieved successfully!</span>';
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>✅ Metadata Retrieval Test</h3>
                            <p><strong>Hash:</strong> ${hash.substring(0, 16)}...</p>
                            <p><strong>Title:</strong> ${metadata.title}</p>
                            <p><strong>Artist:</strong> ${metadata.artist}</p>
                            <p><strong>Album:</strong> ${metadata.album}</p>
                            <p><strong>Year:</strong> ${metadata.year}</p>
                            <p><strong>Genre:</strong> ${metadata.genre}</p>
                            <p><strong>Duration:</strong> ${metadata.duration}s</p>
                            <p><strong>Album Art Hash:</strong> ${metadata.album_art_hash || 'None'}</p>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = '<span class="warning">⚠️ No metadata found for hash</span>';
                    resultsDiv.innerHTML = `
                        <div class="warning">
                            <h3>⚠️ Metadata Retrieval Test</h3>
                            <p>No metadata found for hash: ${hash.substring(0, 16)}...</p>
                            <p>Try storing metadata first using the "Test Metadata Storage" button.</p>
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">❌ Metadata retrieval failed: ${error.message}</span>`;
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Metadata Retrieval Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        };

        window.getDatabaseStats = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                statusDiv.innerHTML = '<span class="info">📊 Getting database statistics...</span>';
                
                const stats = await metadataStore.getStats();
                
                statusDiv.innerHTML = '<span class="success">✅ Database statistics retrieved!</span>';
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>📊 Database Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">${stats.metadataCount}</div>
                                <div class="stat-label">Metadata Records</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.albumArtCount}</div>
                                <div class="stat-label">Album Art Records</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.trackCount}</div>
                                <div class="stat-label">Tracks</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.albumCount}</div>
                                <div class="stat-label">Albums</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.artistCount}</div>
                                <div class="stat-label">Artists</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${stats.genreCount}</div>
                                <div class="stat-label">Genres</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">❌ Failed to get database statistics: ${error.message}</span>`;
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Database Statistics Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        };

        window.cleanupUnusedArt = async function() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                statusDiv.innerHTML = '<span class="info">🧹 Cleaning up unused album art...</span>';
                
                // For this test, we'll just show a success message
                // In the real implementation, this would clean up unused album art
                
                statusDiv.innerHTML = '<span class="success">✅ Cleanup completed!</span>';
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>🧹 Album Art Cleanup</h3>
                        <p>Cleanup operation completed successfully.</p>
                        <p>Note: This is a test implementation. In the real app, this would remove album art that hasn't been used in 30 days.</p>
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">❌ Cleanup failed: ${error.message}</span>`;
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Cleanup Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        };

        window.clearAllData = async function() {
            if (!confirm('Are you sure you want to clear all test data? This action cannot be undone.')) {
                return;
            }

            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                statusDiv.innerHTML = '<span class="info">🗑️ Clearing all data...</span>';
                
                await metadataStore.clearAll();
                
                statusDiv.innerHTML = '<span class="success">✅ All data cleared successfully!</span>';
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>🗑️ Data Clear</h3>
                        <p>All test data has been cleared from the database.</p>
                        <p>You can now run the storage tests again to verify the system works correctly.</p>
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">❌ Failed to clear data: ${error.message}</span>`;
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>❌ Data Clear Error</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        };

        // Auto-initialize database on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testDatabaseInit();
            }, 1000);
        });
    </script>
</body>
</html>
