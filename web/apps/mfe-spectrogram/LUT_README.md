# LUT (Look-Up Table) Support

This document describes the LUT (Look-Up Table) functionality added to the Kofft Spectrogram web application.

## Overview

LUT support provides sophisticated color mapping capabilities for the spectrogram visualization. Instead of using a simple 4-color gradient system, LUTs allow for:

- **Precise color control**: Define exact colors at specific positions
- **Multiple interpolation methods**: Linear, cubic, and step interpolation
- **Built-in color maps**: Popular scientific color maps like Viridis, Plasma, Inferno
- **Custom color maps**: Create and save your own color schemes
- **File import/export**: Support for .cube format LUT files

## Features

### Built-in Color Maps

The application includes several popular scientific color maps:

- **Viridis**: Perceptually uniform color map from dark blue to yellow
- **Plasma**: Perceptually uniform color map from dark purple to yellow
- **Inferno**: Perceptually uniform color map from black to bright yellow
- **Magma**: Perceptually uniform color map from black to bright pink
- **Cividis**: Colorblind-friendly perceptually uniform color map
- **Turbo**: High contrast color map with smooth transitions
- **Rainbow**: Classic rainbow color map
- **Fire**: Fire-like color map from black to white
- **Grayscale**: Simple grayscale color map

### Custom Color Maps

Users can create custom color maps by:

1. Defining color stops at specific positions (0.0 to 1.0)
2. Choosing interpolation method (linear, cubic, step)
3. Saving and reusing custom maps

### File Import/Export

- **Import**: Support for .cube format LUT files with preview functionality
- **Export**: Export custom color maps to .cube format for use in other applications
- **Preview**: Visual preview of imported color maps before applying

## Technical Implementation

### Core Components

1. **LUT Types** (`src/shared/types/index.ts`)
   - `LUTEntry`: Individual color stop with position and RGBA color
   - `LUT`: Complete color map with entries and interpolation method
   - `LUTMode`: Mode selection (builtin, custom, file)

2. **LUT Utilities** (`src/shared/utils/lut.ts`)
   - Color interpolation functions
   - LUT texture generation for WebGL
   - File import/export functions
   - Built-in LUT definitions

3. **Settings Store** (`src/shared/stores/settingsStore.ts`)
   - LUT state management
   - Custom LUT storage
   - Settings persistence

4. **Spectrogram Canvas** (`src/features/spectrogram/SpectrogramCanvas.tsx`)
   - WebGL shader integration
   - LUT texture sampling
   - Real-time color mapping

5. **Settings Panel** (`src/features/settings/LUTSettingsPanel.tsx`)
   - User interface for LUT management
   - Built-in map selection with visual previews
   - Custom map creation
   - File import/export with preview functionality

### WebGL Integration

The spectrogram rendering uses WebGL with LUT textures:

```glsl
// Fragment shader snippet
uniform sampler2D u_lutTexture;
uniform float u_lutResolution;

void main() {
  float intensity = texture2D(u_texture, v_texCoord).r;
  float lutIndex = intensity * (u_lutResolution - 1.0);
  float lutCoord = (lutIndex + 0.5) / u_lutResolution;
  vec4 color = texture2D(u_lutTexture, vec2(lutCoord, 0.5));
  gl_FragColor = color;
}
```

### Color Interpolation

Three interpolation methods are supported:

1. **Linear**: Standard linear interpolation between color stops
2. **Cubic**: Smooth cubic interpolation using smoothstep function
3. **Step**: Discrete color steps without interpolation

## Usage

### Accessing LUT Settings

1. Open the Settings panel (gear icon)
2. Navigate to the "Color Maps" tab
3. Choose from built-in maps, create custom maps, or import files

### Creating Custom Color Maps

1. Select "Custom Maps" mode
2. Click "Create New" to generate a default 5-color map
3. Adjust colors using the color picker interface
4. The map is automatically applied to the spectrogram

### Importing LUT Files

1. Select "Import from File" mode
2. Choose a .cube format LUT file
3. Preview the imported color map with detailed information:
   - Color map preview gradient
   - File metadata (name, description, interpolation method)
   - Number of color entries
   - Sample color stops with positions
4. Click "Apply" to add it to custom maps and apply it, or "Cancel" to discard

### Exporting Color Maps

1. Select any color map (built-in or custom)
2. Click "Export" to download as .cube file
3. Use the exported file in other applications

## File Format Support

### .cube Format

The application supports the standard .cube LUT format:

```
# LUT generated by Kofft Spectrogram
# Viridis
# Perceptually uniform color map from dark blue to yellow

LUT_3D_SIZE 32
DOMAIN_MIN 0.0 0.0 0.0
DOMAIN_MAX 1.0 1.0 1.0

0.267004 0.004874 0.329415
0.268510 0.009605 0.335427
...
```

## Performance Considerations

- LUT textures are generated at 256x1 resolution for optimal performance
- Color mapping is performed in the GPU fragment shader
- Custom LUTs are cached and only regenerated when changed
- Built-in LUTs are pre-computed and stored as constants

## Future Enhancements

Potential improvements for the LUT system:

1. **More file formats**: Support for .3dl, .csp, .dat formats
2. **Advanced interpolation**: Catmull-Rom, B-spline interpolation
3. **Color space support**: HSV, LAB, XYZ color spaces
4. **Animation**: Animated color maps for time-varying data
5. **Presets**: User-defined preset collections
6. **Sharing**: Export/import custom LUT collections
7. **Enhanced previews**: 3D preview of color maps, side-by-side comparisons
8. **Batch import**: Import multiple LUT files at once

## API Reference

### LUT Interface

```typescript
interface LUT {
  id: string
  name: string
  description?: string
  entries: LUTEntry[]
  interpolation: 'linear' | 'cubic' | 'step'
}

interface LUTEntry {
  position: number // 0.0 to 1.0
  color: [number, number, number, number] // RGBA values
}
```

### Key Functions

```typescript
// Map a value to a color using a LUT
mapValueToColor(value: number, lut: LUT): [number, number, number, number]

// Generate WebGL texture from LUT
generateLUTTexture(lut: LUT, resolution?: number): Uint8Array

// Create custom LUT
createCustomLUT(id: string, name: string, colors: RGBA[], interpolation: string, description?: string): LUT

// Import LUT from file
importLUTFromFile(file: File): Promise<LUT>

// Export LUT to .cube format
exportLUTToCube(lut: LUT): string
```

## Examples

### Creating a Simple Grayscale LUT

```typescript
import { createCustomLUT } from '@/shared/utils/lut'

const grayscaleLUT = createCustomLUT(
  'grayscale',
  'Grayscale',
  [
    [0, 0, 0, 1],    // Black
    [1, 1, 1, 1]     // White
  ],
  'linear',
  'Simple grayscale color map'
)
```

### Using a Built-in LUT

```typescript
import { BUILTIN_LUTS, mapValueToColor } from '@/shared/utils/lut'

const viridisLUT = BUILTIN_LUTS.viridis
const color = mapValueToColor(0.5, viridisLUT)
// Returns: [0.127568, 0.566949, 0.550556, 1.0]
```

This LUT system provides a powerful and flexible foundation for color mapping in the spectrogram visualization, enabling both scientific accuracy and artistic expression.
